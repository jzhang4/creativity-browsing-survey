"use strict";

/* jshint node: true */

/*
 * This builds on the webServer of previous projects in that it exports the current
 * directory via webserver listing on a hard code (see portno below) port. It also
 * establishes a connection to the MongoDB named 'cs142project6'.
 *
 * To start the webserver run the command:
 *    node webServer.js
 *
 * Note that anyone able to connect to localhost:portNo will be able to fetch any file accessible
 * to the current user in the current directory or any of its children.
 *
 * This webServer exports the following URLs:
 * /              -  Returns a text status message.  Good for testing web server running.
 * /test          - (Same as /test/info)
 * /test/info     -  Returns the SchemaInfo object from the database (JSON format).  Good
 *                   for testing database connectivity.
 * /test/counts   -  Returns the population counts of the cs142 collections in the database.
 *                   Format is a JSON object with properties being the collection name and
 *                   the values being the counts.
 *
 * The following URLs need to be implemented:
 * /user/list     -  Returns an array containing all the User objects from the database.
 *                   (JSON format)
 * /user/:id      -  Returns the User object with the _id of id. (JSON format).
 * /photosOfUser/:id' - Returns an array with all the photos of the User (id). Each photo
 *                      should have all the Comments on the Photo (JSON format)
 *
 */

var mongoose = require('mongoose');
var async = require('async');

var session = require('express-session');
var bodyParser = require('body-parser');
var multer = require('multer');

//Load the Mongoose schema for SurveyResult
var SurveyResult = require('./Schema/SurveyResult.js');

var express = require('express');
var app = express();

app.use(session({secret: 'secretKey', resave: false, saveUninitialized: false}));
app.use(bodyParser.json({limit: '1000mb'}));

var is_heroku = false;
var mongo_url = 'mongodb://localhost/hci-project';
if (process.env.MONGODB_URI) {
    is_heroku = true;
    mongo_url = process.env.MONGODB_URI;
}
var http_port = 3000
if (process.env.PORT) {
    http_port = process.env.PORT;
}

mongoose.connect(mongo_url);

// We have the express static module (http://expressjs.com/en/starter/static-files.html) do all
// the work for us.
app.use(express.static(__dirname));

app.post('/surveyResult', function(request, response) {

    var id = request.body.id;
    var num_correct = request.body.num_correct;
    var num_total = request.body.num_total;

    SurveyResult.create({id: id,
                     num_correct: num_correct,
                     num_total: num_total,
                }, function(err, result) {
                console.log('Saved new survey result');
                console.log(result);
                response.status(200).send(JSON.stringify(result)); 
        }); 

});

require('./log_history')(app)
if (!is_heroku) { // disable this on heroku to avoid potentially crashing the server
    require('./view_history')(app)
}

var server = app.listen(http_port, function () {
    var port = server.address().port;
    console.log('Listening at http://localhost:' + port + ' exporting the directory ' + __dirname);
});

